var H5P=H5P||{};H5P.Essay=function($,Question){'use strict';const SOLUTION_CONTAINER='h5p-essay-solution-container';const SOLUTION_TITLE='h5p-essay-solution-title';const SOLUTION_INTRODUCTION='h5p-essay-solution-introduction';const SOLUTION_SAMPLE='h5p-essay-solution-sample';const SOLUTION_SAMPLE_TEXT='h5p-essay-solution-sample-text';const FEEDBACK_EMPTY='<span class="h5p-essay-feedback-empty">...</span>';function Essay(config,contentId,contentData){if(!config){return;}
Question.call(this,'essay');this.params=Essay.extend({media:{},taskDescription:'',solution:{},keywords:[],overallFeedback:[],behaviour:{minimumLength:0,inputFieldSize:10,enableCheckButton:true,enableRetry:true,ignoreScoring:false,pointsHost:1},checkAnswer:'Check',submitAnswer:'Submit',tryAgain:'Retry',showSolution:'Show solution',feedbackHeader:'Feedback',solutionTitle:'Sample solution',remainingChars:'Remaining characters: @chars',notEnoughChars:'You must enter at least @chars characters!',messageSave:'saved',ariaYourResult:'You got @score out of @total points',ariaNavigatedToSolution:'Navigated to newly included sample solution after textarea.',ariaCheck:'Check the answers.',ariaShowSolution:'Show the solution. You will be provided with a sample solution.',ariaRetry:'Retry the task. You can improve your previous answer if the author allowed that.'},config);this.contentId=contentId;this.extras=contentData;const defaultLanguage=(this.extras&&this.extras.metadata)?this.extras.metadata.defaultLanguage||'en':'en';this.languageTag=Essay.formatLanguageCode(defaultLanguage);this.score=0;this.internalShowSolutionsCall=false;this.params.placeholderText=this.htmlDecode(this.params.placeholderText||'');if(typeof contentData!=='undefined'&&typeof contentData.previousState!=='undefined'){this.previousState=contentData.previousState;}
this.isAnswered=this.previousState&&this.previousState.inputField&&this.previousState.inputField!==''||false;this.params.behaviour.enableSolutionsButton=(typeof this.params.solution.sample!=='undefined'&&this.params.solution.sample!=='');this.params.behaviour.enableRetry=this.params.behaviour.enableRetry||false;this.params.behaviour.minimumLength=this.params.behaviour.minimumLength||0;if(this.params.behaviour.maximumLength!==undefined){this.params.behaviour.minimumLength=Math.min(this.params.behaviour.minimumLength,this.params.behaviour.maximumLength);}
const toPoints=function(keyword){return(keyword.keyword&&keyword.options&&keyword.options.points||0)*(keyword.options.occurrences||1);};const sum=function(a,b){return a+b;};const scoreMax=this.params.keywords.map(toPoints).reduce(sum,0);this.scoreMastering=this.params.behaviour.percentageMastering===undefined?scoreMax:this.params.behaviour.percentageMastering*scoreMax/100;this.scorePassing=Math.min(this.getMaxScore(),this.params.behaviour.percentagePassing*scoreMax/100||0);this.solution=this.buildSolution();if(typeof this.previousState==='object'&&Object.keys(this.previousState).length){this.updateScore();}}
Essay.prototype=Object.create(Question.prototype);Essay.prototype.constructor=Essay;Essay.prototype.registerDomElements=function(){const that=this;const media=(this.params.media)?this.params.media.type:undefined;if(media&&media.library){const type=media.library.split(' ')[0];if(type==='H5P.Image'){if(media.params.file){this.setImage(media.params.file.path,{disableImageZooming:this.params.media.disableImageZooming,alt:media.params.alt,title:media.params.title});}}
else if(type==='H5P.Video'){if(media.params.sources){this.setVideo(media);}}
else if(type==='H5P.Audio'){if(media.params.files){this.setAudio(media);}}}
const statusBar=(this.params.behaviour.minimumLength||this.params.behaviour.maximumLength||(H5PIntegration&&H5PIntegration.saveFreq));this.inputField=new H5P.Essay.InputField({taskDescription:this.params.taskDescription,placeholderText:this.params.placeholderText,maximumLength:this.params.behaviour.maximumLength,remainingChars:this.params.remainingChars,inputFieldSize:this.params.behaviour.inputFieldSize,previousState:this.previousState,statusBar:statusBar},{onInteracted:(function(params){that.handleInteracted(params);}),onInput:(function(){that.handleInput();})});this.setViewState(this.previousState&&this.previousState.viewState||'task');if(this.viewState==='results'){H5P.externalDispatcher.on('initialized',function(){that.handleCheckAnswer({skipXAPI:true});});}
else if(this.viewState==='solutions'){H5P.externalDispatcher.on('initialized',function(){that.handleCheckAnswer({skipXAPI:true});that.showSolutions();if(that.getScore()<that.getMaxScore()||that.params.behaviour.ignoreScoring||that.getMaxScore()===0){if(that.params.behaviour.enableRetry){that.showButton('try-again');}}
else{that.hideButton('try-again');}});}
this.setIntroduction(this.inputField.getIntroduction());this.content=this.inputField.getContent();this.setContent(this.content);this.addButtons();};Essay.prototype.addButtons=function(){const that=this;that.addButton('show-solution',that.params.showSolution,function(){that.internalShowSolutionsCall=true;that.showSolutions();that.internalShowSolutionsCall=false;},false,{'aria-label':this.params.ariaShowSolution},{});that.addButton('check-answer',that.params.checkAnswer,function(){that.handleCheckAnswer();},this.params.behaviour.enableCheckButton,{'aria-label':this.params.ariaCheck},{contentData:this.extras,textIfSubmitting:this.params.submitAnswer,});that.addButton('try-again',that.params.tryAgain,function(){that.resetTask({skipClear:true});},false,{'aria-label':this.params.ariaRetry},{});};Essay.prototype.handleCheckAnswer=function(params){const that=this;params=Essay.extend({skipXAPI:false},params);if(that.inputField.getText().length<that.params.behaviour.minimumLength){const message=that.params.notEnoughChars.replace(/@chars/g,that.params.behaviour.minimumLength);that.inputField.setMessageChars(message,true);that.read(message);return;}
that.setViewState('results');that.inputField.disable();that.isAnswered=true;that.handleEvaluation(params);if(that.params.behaviour.enableSolutionsButton===true){that.showButton('show-solution');}
that.hideButton('check-answer');};Essay.prototype.getInput=function(linebreakReplacement){linebreakReplacement=linebreakReplacement||' ';let userText='';if(this.inputField){userText=this.inputField.getText();}
else if(this.previousState&&this.previousState.inputField){userText=this.previousState.inputField;}
return userText.replace(/(\r\n|\r|\n)/g,linebreakReplacement).replace(/\s\s/g,' ');};Essay.prototype.handleInteracted=function(params){params=params||{};this.isAnswered=this.isAnswered||this.inputField.getText().length>0;if(params.updateScore){this.updateScore();}
this.triggerXAPI('interacted');};Essay.prototype.getAnswerGiven=function(){return this.isAnswered;};Essay.prototype.getScore=function(){return(this.params.behaviour.ignoreScoring)?this.getMaxScore():Math.round(this.score);};Essay.prototype.getMaxScore=function(){return(this.params.behaviour.ignoreScoring)?this.params.behaviour.pointsHost||0:Math.round(this.scoreMastering);};Essay.prototype.showSolutions=function(){this.setViewState('solutions');this.inputField.disable();if(typeof this.params.solution.sample!=='undefined'&&this.params.solution.sample!==''){if(this.solution.getElementsByClassName(SOLUTION_SAMPLE)[0].children.length===0){const text=document.createElement('div');text.classList.add(SOLUTION_SAMPLE_TEXT);text.innerHTML=this.params.solution.sample;this.solution.getElementsByClassName(SOLUTION_SAMPLE)[0].appendChild(text);}
const predecessor=this.content.parentNode;predecessor.parentNode.insertBefore(this.solution,predecessor.nextSibling);this.solutionAnnouncer.focus();}
this.hideButton('show-solution');if(!this.internalShowSolutionsCall){this.hideButton('check-answer');this.hideButton('try-again');}
this.trigger('resize');};Essay.prototype.resetTask=function(params){params=params||{};this.setViewState('task');this.setExplanation();this.removeFeedback();this.hideSolution();this.hideButton('show-solution');this.hideButton('try-again');if(this.params.behaviour.enableCheckButton){this.showButton('check-answer');}
if(!params.skipClear){this.inputField.setText('');}
this.inputField.enable();this.inputField.focus();this.isAnswered=false;};Essay.prototype.getXAPIData=function(){return{statement:this.getXAPIAnswerEvent().data.statement};};Essay.prototype.isPassed=function(){return(this.params.behaviour.ignoreScoring||this.getScore()>=this.scorePassing);};Essay.prototype.updateScore=function(results){results=results||this.computeResults();this.score=Math.min(this.computeScore(results),this.getMaxScore());};Essay.prototype.handleEvaluation=function(params){params=Essay.extend({skipXAPI:false},params);const results=this.computeResults();const explanations=this.buildExplanation(results);if(explanations.length>0){this.setExplanation(explanations,this.params.feedbackHeader);}
this.updateScore(results);const textScore=H5P.Question.determineOverallFeedback(this.params.overallFeedback,this.getScore()/this.getMaxScore()).replace('@score',this.getScore()).replace('@total',this.getMaxScore());if(!this.params.behaviour.ignoreScoring&&this.getMaxScore()>0){const ariaMessage=(this.params.ariaYourResult).replace('@score',':num').replace('@total',':total');this.setFeedback(textScore,this.getScore(),this.getMaxScore(),ariaMessage);}
this.handleButtons(this.getScore());if(!params.skipXAPI){this.handleXAPI();}
this.trigger('resize');};Essay.prototype.buildSolution=function(){const solution=document.createElement('div');solution.classList.add(SOLUTION_CONTAINER);this.solutionAnnouncer=document.createElement('div');this.solutionAnnouncer.setAttribute('tabindex','0');this.solutionAnnouncer.setAttribute('aria-label',this.params.ariaNavigatedToSolution);this.solutionAnnouncer.addEventListener('focus',function(event){event.target.blur();event.target.setAttribute('tabindex','-1');});solution.appendChild(this.solutionAnnouncer);const solutionTitle=document.createElement('div');solutionTitle.classList.add(SOLUTION_TITLE);solutionTitle.innerHTML=this.params.solutionTitle;solution.appendChild(solutionTitle);const solutionIntroduction=document.createElement('div');solutionIntroduction.classList.add(SOLUTION_INTRODUCTION);solutionIntroduction.innerHTML=this.params.solution.introduction;solution.appendChild(solutionIntroduction);const solutionSample=document.createElement('div');solutionSample.classList.add(SOLUTION_SAMPLE);solution.appendChild(solutionSample);return solution;};Essay.prototype.hideSolution=function(){if(this.solution.parentNode!==null){this.solution.parentNode.removeChild(this.solution);}};Essay.prototype.computeResults=function(){const that=this;const results=[];this.params.keywords=this.params.keywords||[];this.params.keywords=this.params.keywords.filter(function(element){return typeof element.keyword!=='undefined';});this.params.keywords.forEach(function(alternativeGroup){const resultsGroup=[];const options=alternativeGroup.options;const caseSensitive=(that.params.behaviour.overrideCaseSensitive!=='off')&&(that.params.behaviour.overrideCaseSensitive==='on'||options.caseSensitive);let alternatives=[alternativeGroup.keyword||[]].concat(alternativeGroup.alternatives||[]).map(function(alternative){return that.htmlDecode(alternative);});const regularExpressionMatches=that.getRegExpAlternatives(alternatives,that.getInput(),caseSensitive).map(function(match){return match=match.replace(/\*/,Essay.REGULAR_EXPRESSION_ASTERISK);});alternatives=alternatives.filter(function(alternative){return(alternative[0]!=='/'||alternative[alternative.length-1]!=='/');}).concat(regularExpressionMatches).filter(function(alternative){return alternative!=='';});alternatives.forEach(function(alternative){let inputTest=that.getInput();const caseSensitive=that.params.behaviour.overrideCaseSensitive==='on'||options.caseSensitive;if(!caseSensitive){alternative=alternative.toLowerCase();inputTest=inputTest.toLowerCase();}
const matchesExact=that.detectExactMatches(alternative,inputTest);const matchesWildcard=alternative.indexOf('*')!==-1?that.detectWildcardMatches(alternative,inputTest,caseSensitive):[];const matchesFuzzy=options.forgiveMistakes?that.detectFuzzyMatches(alternative,inputTest):[];that.mergeMatches(matchesExact,matchesWildcard,matchesFuzzy).forEach(function(item){resultsGroup.push(item);});});results.push(resultsGroup);});return results;};Essay.prototype.computeScore=function(results){let score=0;this.params.keywords.forEach(function(keyword,i){score+=Math.min(results[i].length,keyword.options.occurrences)*keyword.options.points;});return score;};Essay.prototype.buildExplanation=function(results){const explanations=[];let word;this.params.keywords.forEach(function(keyword,i){word=FEEDBACK_EMPTY;if(results[i].length===0&&keyword.options.feedbackMissed){if(keyword.options.feedbackMissedWord==='keyword'){word=keyword.keyword;}
explanations.push({correct:word,text:keyword.options.feedbackMissed});}
if(results[i].length>0&&keyword.options.feedbackIncluded){switch(keyword.options.feedbackIncludedWord){case 'keyword':word=keyword.keyword;break;case 'alternative':word=results[i][0].keyword;break;case 'answer':word=results[i][0].match;break;}
explanations.push({correct:word,text:keyword.options.feedbackIncluded});}});if(explanations.length>0){explanations.sort(function(a,b){return a.correct===FEEDBACK_EMPTY&&b.correct!==FEEDBACK_EMPTY;});}
return explanations;};Essay.prototype.handleButtons=function(score){if(this.params.solution.sample&&!this.solution){this.showButton('show-solution');}
if(score<this.getMaxScore()||this.params.behaviour.ignoreScoring||this.getMaxScore()===0){if(this.params.behaviour.enableRetry){this.showButton('try-again');}}
else{this.hideButton('try-again');}};Essay.prototype.handleXAPI=function(){this.trigger(this.getXAPIAnswerEvent());if(!this.params.behaviour.ignoreScoring&&this.getMaxScore()>0){if(this.getScore()<this.scorePassing){this.trigger(this.createEssayXAPIEvent('failed'));}
else{this.trigger(this.createEssayXAPIEvent('passed'));}
if(this.getScore()>=this.getMaxScore()){this.trigger(this.createEssayXAPIEvent('mastered'));}}};Essay.prototype.createEssayXAPIEvent=function(verb){const xAPIEvent=this.createXAPIEventTemplate(verb);Essay.extend(xAPIEvent.getVerifiedStatementValue(['object','definition']),this.getxAPIDefinition());return xAPIEvent;};Essay.prototype.getxAPIDefinition=function(){const definition={};definition.name={};definition.name[this.languageTag]=this.getTitle();definition.name['en-US']=definition.name[this.languageTag];definition.description={};definition.description[this.languageTag]=this.params.taskDescription+Essay.FILL_IN_PLACEHOLDER;definition.description['en-US']=definition.description[this.languageTag];definition.type='http://id.tincanapi.com/activitytype/essay';definition.interactionType='long-fill-in';return definition;};Essay.prototype.getXAPIAnswerEvent=function(){const xAPIEvent=this.createEssayXAPIEvent('answered');xAPIEvent.setScoredResult(this.getScore(),this.getMaxScore(),this,true,this.isPassed());xAPIEvent.data.statement.result.response=this.inputField.getText();return xAPIEvent;};Essay.prototype.detectExactMatches=function(needle,haystack){const result=[];let pos=-1;let front=0;needle=needle.replace(/\*/,'').replace(new RegExp(Essay.REGULAR_EXPRESSION_ASTERISK,'g'),'*');while(((pos=haystack.indexOf(needle)))!==-1&&needle!==''){if(H5P.TextUtilities.isIsolated(needle,haystack)){result.push({'keyword':needle,'match':needle,'index':front+pos});}
front+=pos+needle.length;haystack=haystack.substr(pos+needle.length);}
return result;};Essay.prototype.detectWildcardMatches=function(needle,haystack,caseSensitive){if(needle.indexOf('*')===-1){return[];}
needle=needle.replace(/[*]{2,}/g,'*');const regexpChars=['\\','.','[',']','?','+','(',')','{','}','|','!','^','-'];regexpChars.forEach(function(char){needle=needle.split(char).join('\\'+char);});const regexp=new RegExp(needle.replace(/\*/g,Essay.CHARS_WILDCARD+'+'),this.getRegExpModifiers(caseSensitive));const result=[];let match;while((match=regexp.exec(haystack))!==null){if(H5P.TextUtilities.isIsolated(match[0],haystack,{'index':match.index})){result.push({'keyword':needle,'match':match[0],'index':match.index});}}
return result;};Essay.prototype.detectFuzzyMatches=function(needle,haystack){const windowSize=2;const results=[];for(let size=-windowSize;size<=windowSize;size++){for(let pos=0;pos<haystack.length;pos++){const straw=haystack.substr(pos,needle.length+size);if(H5P.TextUtilities.areSimilar(needle,straw)&&H5P.TextUtilities.isIsolated(straw,haystack,{'index':pos})){if(!this.contains(results,pos)){results.push({'keyword':needle,'match':straw,'index':pos});}}}}
return results;};Essay.prototype.getRegExpAlternatives=function(alternatives,inputTest,caseSensitive){const that=this;return alternatives.filter(function(alternative){return(alternative[0]==='/'&&alternative[alternative.length-1]==='/');}).map(function(alternative){const regNeedle=new RegExp(alternative.slice(1,-1),that.getRegExpModifiers(caseSensitive));return inputTest.match(regNeedle);}).reduce(function(a,b){return a.concat(b);},[]).filter(function(item){return item!==null;});};Essay.prototype.getRegExpModifiers=function(caseSensitive){const modifiers=['g'];if(!caseSensitive){modifiers.push('i');}
return modifiers.join('');};Essay.prototype.mergeMatches=function(){if(arguments.length===0){return[];}
if(arguments.length===1){return arguments[0];}
const results=(arguments[0]||[]).slice();for(let i=1;i<arguments.length;i++){const match2=arguments[i]||[];for(let j=0;j<match2.length;j++){if(!this.contains(results,match2[j].index)){results.push(match2[j]);}}}
return results.sort(function(a,b){return a.index>b.index;});};Essay.prototype.contains=function(results,index){return results.some(function(result){return Math.abs(result.index-index)<=result.match.length;});};Essay.extend=function(){for(let i=1;i<arguments.length;i++){for(let key in arguments[i]){if(Object.prototype.hasOwnProperty.call(arguments[i],key)){if(typeof arguments[0][key]==='object'&&typeof arguments[i][key]==='object'){this.extend(arguments[0][key],arguments[i][key]);}
else{arguments[0][key]=arguments[i][key];}}}}
return arguments[0];};Essay.prototype.getTitle=function(){let raw;if(this.extras.metadata){raw=this.extras.metadata.title;}
raw=raw||Essay.DEFAULT_DESCRIPTION;return H5P.createTitle(raw);};Essay.formatLanguageCode=function(languageCode){if(typeof languageCode!=='string'){return languageCode;}
const segments=languageCode.split('-');segments[0]=segments[0].toLowerCase();if(segments.length>1){segments[1]=segments[1].toUpperCase();}
languageCode=segments.join('-');return languageCode;};Essay.prototype.htmlDecode=function(input){const dparser=new DOMParser().parseFromString(input,'text/html');return dparser.documentElement.textContent;};Essay.prototype.getCurrentState=function(){if(!this.inputField){return;}
this.inputField.updateMessageSaved(this.params.messageSave);return{inputField:this.inputField.getText(),viewState:this.viewState};};Essay.prototype.setViewState=function(state){if(Essay.VIEW_STATES.indexOf(state)===-1){return;}
this.viewState=state;};Essay.CHARS_WILDCARD='[A-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u00FF\u0370-\u03FF\u0400-\u04FF\u3040-\u309F\u3040-\u30FF\u4E00-\u62FF\u6300-\u77FF\u7800-\u8CFF\u8D00-\u9FFF\u0E00-\u0E7F]';Essay.FILL_IN_PLACEHOLDER='__________';Essay.DEFAULT_DESCRIPTION='Essay';Essay.REGULAR_EXPRESSION_ASTERISK=':::H5P-Essay-REGEXP-ASTERISK:::';Essay.VIEW_STATES=['task','results','solutions'];return Essay;}(H5P.jQuery,H5P.Question);