H5P.VideoVimeo=(function($){let numInstances=0;function VimeoPlayer(sources,options,l10n){const self=this;let player;let buffered=0;let currentQuality;let currentTextTrack;let currentTime=0;let duration=0;let isMuted=0;let volume=0;let playbackRate=1;let qualities=[];let loadingFailedTimeout;let failedLoading=false;let ratio=9/16;const LOADING_TIMEOUT_IN_SECONDS=8;const id=`h5p-vimeo-${++numInstances}`;const $wrapper=$('<div/>');const $placeholder=$('<div/>',{id:id,html:`<div class="h5p-video-loading" style="height: 100%; min-height: 200px; display: block; z-index: 100;" aria-label="${l10n.loading}"></div>`}).appendTo($wrapper);const createVimeoPlayer=async()=>{if(!$placeholder.is(':visible')||player!==undefined){return;}
player=null;const Vimeo=await loadVimeoPlayerSDK();const MIN_WIDTH=200;const width=Math.max($wrapper.width(),MIN_WIDTH);const embedOptions={url:sources[0].path,controls:options.controls?true:false,responsive:true,dnt:true,autoplay:false,loop:options.loop?true:false,playsinline:true,quality:'auto',width:width};player=new Vimeo.Player(id,embedOptions);registerVimeoPlayerEventListeneners(player);loadingFailedTimeout=setTimeout(()=>{failedLoading=true;removeLoadingIndicator();$wrapper.html(`<p class="vimeo-failed-loading">${l10n.vimeoLoadingError}</p>`);$wrapper.css({width:null,height:null});self.trigger('resize');self.trigger('error',l10n.vimeoLoadingError);},LOADING_TIMEOUT_IN_SECONDS*1000);}
const removeLoadingIndicator=()=>{$placeholder.find('div.h5p-video-loading').remove();};const registerVimeoPlayerEventListeneners=(player)=>{player.on('loaded',async()=>{clearTimeout(loadingFailedTimeout);const videoDetails=await getVimeoVideoMetadata(player);const{tracks}=videoDetails;currentTextTrack=tracks.current;duration=videoDetails.duration;qualities=videoDetails.qualities;currentQuality='auto';try{ratio=videoDetails.dimensions.height/videoDetails.dimensions.width;}
catch(e){}
removeLoadingIndicator();if(options.startAt){currentTime=await self.seek(options.startAt);}
self.trigger('ready');self.trigger('loaded');self.trigger('captions',tracks.options);self.trigger('qualityChange',currentQuality);self.trigger('resize');});player.on('playing',()=>self.trigger('stateChange',H5P.Video.PLAYING));player.on('pause',()=>self.trigger('stateChange',H5P.Video.PAUSED));player.on('ended',()=>self.trigger('stateChange',H5P.Video.ENDED));player.on('progress',(data)=>{buffered=data.percent*100;});player.on('timeupdate',(time)=>{currentTime=time.seconds;});};const getVimeoVideoMetadata=(player)=>{const massageVideoMetadata=(data)=>{const duration=data[0];const qualities=data[1].map(q=>({name:q.id,label:q.label}));const tracks=data[2].reduce((tracks,current)=>{const h5pVideoTrack=new H5P.Video.LabelValue(current.label,current.language);tracks.options.push(h5pVideoTrack);if(current.mode==='showing'){tracks.current=h5pVideoTrack;}
return tracks;},{current:undefined,options:[]});const dimensions={width:data[3],height:data[4]};return{duration,qualities,tracks,dimensions};};return Promise.all([player.getDuration(),player.getQualities(),player.getTextTracks(),player.getVideoWidth(),player.getVideoHeight(),]).then(data=>massageVideoMetadata(data));}
self.appendTo=($container)=>{$container.addClass('h5p-vimeo').append($wrapper);createVimeoPlayer();};self.getQualities=()=>{return qualities;};self.getQuality=()=>{return currentQuality;};self.setQuality=async(quality)=>{currentQuality=await player.setQuality(quality);self.trigger('qualityChange',currentQuality);};self.play=async()=>{if(!player){self.on('ready',self.play);return;}
try{await player.play();}
catch(error){switch(error.name){case 'PasswordError':self.trigger('error',l10n.vimeoPasswordError);break;case 'PrivacyError':self.trigger('error',l10n.vimeoPrivacyError);break;default:self.trigger('error',l10n.unknownError);break;}}};self.pause=()=>{if(player){player.pause();}};self.seek=async(time)=>{currentTime=await player.setCurrentTime(time);};self.getCurrentTime=()=>{return currentTime;};self.getDuration=()=>{return duration;};self.getBuffered=()=>{return buffered;};self.mute=async()=>{isMuted=await player.setMuted(true);};self.unMute=async()=>{isMuted=await player.setMuted(false);};self.isMuted=()=>{return isMuted;};self.getVolume=()=>{return volume;};self.setVolume=async(level)=>{volume=await player.setVolume(level);};self.getPlaybackRates=()=>{return[0.5,1,1.5,2];};self.getPlaybackRate=()=>{return playbackRate;};self.setPlaybackRate=async(rate)=>{playbackRate=await player.setPlaybackRate(rate);self.trigger('playbackRateChange',rate);};self.setCaptionsTrack=(track)=>{if(!track){return player.disableTextTrack().then(()=>{currentTextTrack=null;});}
player.enableTextTrack(track.value).then(()=>{currentTextTrack=track;});};self.getCaptionsTrack=()=>{return currentTextTrack;};self.on('resize',()=>{if(failedLoading||!$wrapper.is(':visible')){return;}
if(player===undefined){createVimeoPlayer();return;}
$wrapper.css({width:'100%',height:'auto'});const width=$wrapper[0].clientWidth;const height=options.fit?$wrapper[0].clientHeight:(width*(ratio));if(height>0){$wrapper.css({width:width+'px',height:height+'px'});}});}
VimeoPlayer.canPlay=(sources)=>{return getId(sources[0].path);};const getId=(url)=>{const matches=url.match(/^.*(vimeo\.com\/)((channels\/[A-z]+\/)|(groups\/[A-z]+\/videos\/))?([0-9]+)/);if(matches&&matches[5]){return matches[5];}};const loadVimeoPlayerSDK=async()=>{if(window.Vimeo){return await Promise.resolve(window.Vimeo);}
return await new Promise((resolve,reject)=>{const tag=document.createElement('script');tag.src='https://player.vimeo.com/api/player.js';tag.onload=()=>resolve(window.Vimeo);tag.onerror=reject;document.querySelector('script').before(tag);});};return VimeoPlayer;})(H5P.jQuery);H5P.videoHandlers=H5P.videoHandlers||[];H5P.videoHandlers.push(H5P.VideoVimeo);